drop table if exists t0,t1,t2,t3;
create table t0(a int);
insert into t0 values (0),(1),(2),(3),(4),(5),(6),(7),(8),(9);
create table t1(a int);
insert into t1 select A.a + B.a* 10 from t0 A, t0 B;
create table t2 (pk int primary key, a datetime, b date, key(a), key(b));
insert into t2 
select 
A.a*10+B.a, 
date_add(date_add('2017-01-01', interval A.a*8 day), interval B.a hour), 
date_add('2017-01-01', interval A.a*7 day)
from t1 A, t0 B;
#
# "YEAR(datetime_col) CMP year_value", basic checks
#
select count(*) from t2 where year(a) < 2018;
count(*)
460
select count(*) from t2 where a < '2018-01-01';
count(*)
460
explain format=json select * from t2 force index(a) where year(a) <  2018;
EXPLAIN
{
  "query_block": {
    "select_id": 1,
    "nested_loop": [
      {
        "table": {
          "table_name": "t2",
          "access_type": "range",
          "possible_keys": ["a"],
          "key": "a",
          "key_length": "6",
          "used_key_parts": ["a"],
          "rows": 451,
          "filtered": 100,
          "index_condition": "t2.a < <cache>(year_start(2018))"
        }
      }
    ]
  }
}
select count(*) from t2 where year(a) <= 2018;
count(*)
920
select count(*) from t2 where a < '2019-01-01';
count(*)
920
explain format=json select * from t2 force index(a) where year(a) <= 2018;
EXPLAIN
{
  "query_block": {
    "select_id": 1,
    "nested_loop": [
      {
        "table": {
          "table_name": "t2",
          "access_type": "range",
          "possible_keys": ["a"],
          "key": "a",
          "key_length": "6",
          "used_key_parts": ["a"],
          "rows": 903,
          "filtered": 100,
          "index_condition": "t2.a <= <cache>(year_end(2018))"
        }
      }
    ]
  }
}
select count(*) from t2 where year(a) > 2018;
count(*)
80
select count(*) from t2 where a > '2018-12-31 23:59:59.9999';
count(*)
80
explain format=json select * from t2 force index(a) where year(a) >  2018;
EXPLAIN
{
  "query_block": {
    "select_id": 1,
    "nested_loop": [
      {
        "table": {
          "table_name": "t2",
          "access_type": "range",
          "possible_keys": ["a"],
          "key": "a",
          "key_length": "6",
          "used_key_parts": ["a"],
          "rows": 97,
          "filtered": 100,
          "index_condition": "t2.a > <cache>(year_end(2018))"
        }
      }
    ]
  }
}
select count(*) from t2 where year(a) >= 2018;
count(*)
540
select count(*) from t2 where a >= '2018-01-01';
count(*)
540
explain format=json select * from t2 force index(a) where year(a) >= 2018;
EXPLAIN
{
  "query_block": {
    "select_id": 1,
    "nested_loop": [
      {
        "table": {
          "table_name": "t2",
          "access_type": "range",
          "possible_keys": ["a"],
          "key": "a",
          "key_length": "6",
          "used_key_parts": ["a"],
          "rows": 549,
          "filtered": 100,
          "index_condition": "t2.a >= <cache>(year_start(2018))"
        }
      }
    ]
  }
}
select count(*) from t2 where year(a) = 2017;
count(*)
460
select count(*) from t2 where a >= '2017-01-01' and a < '2018-01-01';
count(*)
460
explain format=json select * from t2 force index(a) where year(a) =  2017;
EXPLAIN
{
  "query_block": {
    "select_id": 1,
    "nested_loop": [
      {
        "table": {
          "table_name": "t2",
          "access_type": "range",
          "possible_keys": ["a"],
          "key": "a",
          "key_length": "6",
          "used_key_parts": ["a"],
          "rows": 451,
          "filtered": 100,
          "index_condition": "t2.a >= <cache>(year_start(2017)) and t2.a <= <cache>(year_end(2017))"
        }
      }
    ]
  }
}
#
# "YEAR(datetime_col) CMP year_value", reverse argument order
#
select count(*) from t2 where 2017 < year(a);
count(*)
540
select count(*) from t2 where a >= '2018-01-01';
count(*)
540
explain format=json select * from t2 force index(a) where 2017 <  year(a);
EXPLAIN
{
  "query_block": {
    "select_id": 1,
    "nested_loop": [
      {
        "table": {
          "table_name": "t2",
          "access_type": "range",
          "possible_keys": ["a"],
          "key": "a",
          "key_length": "6",
          "used_key_parts": ["a"],
          "rows": 549,
          "filtered": 100,
          "index_condition": "t2.a > <cache>(year_end(2017))"
        }
      }
    ]
  }
}
select count(*) from t2 where 2018 <= year(a);
count(*)
540
select count(*) from t2 where a >= '2018-01-01';
count(*)
540
explain format=json select * from t2 force index(a) where 2018 <= year(a);
EXPLAIN
{
  "query_block": {
    "select_id": 1,
    "nested_loop": [
      {
        "table": {
          "table_name": "t2",
          "access_type": "range",
          "possible_keys": ["a"],
          "key": "a",
          "key_length": "6",
          "used_key_parts": ["a"],
          "rows": 549,
          "filtered": 100,
          "index_condition": "t2.a >= <cache>(year_start(2018))"
        }
      }
    ]
  }
}
select count(*) from t2 where 2018 > year(a);
count(*)
460
select count(*) from t2 where a < '2018-01-01';
count(*)
460
explain format=json select * from t2 force index(a) where 2018 >  year(a);
EXPLAIN
{
  "query_block": {
    "select_id": 1,
    "nested_loop": [
      {
        "table": {
          "table_name": "t2",
          "access_type": "range",
          "possible_keys": ["a"],
          "key": "a",
          "key_length": "6",
          "used_key_parts": ["a"],
          "rows": 451,
          "filtered": 100,
          "index_condition": "t2.a < <cache>(year_start(2018))"
        }
      }
    ]
  }
}
select count(*) from t2 where 2018 >= year(a);
count(*)
920
select count(*) from t2 where a < '2019-01-01';
count(*)
920
explain format=json select * from t2 force index(a) where 2018 >= year(a);
EXPLAIN
{
  "query_block": {
    "select_id": 1,
    "nested_loop": [
      {
        "table": {
          "table_name": "t2",
          "access_type": "range",
          "possible_keys": ["a"],
          "key": "a",
          "key_length": "6",
          "used_key_parts": ["a"],
          "rows": 903,
          "filtered": 100,
          "index_condition": "t2.a <= <cache>(year_end(2018))"
        }
      }
    ]
  }
}
select count(*) from t2 where 2018 =  year(a);
count(*)
460
select count(*) from t2 where a >= '2018-01-01' and a < '2019-01-01';
count(*)
460
explain format=json select * from t2 force index(a) where 2018 =  year(a);
EXPLAIN
{
  "query_block": {
    "select_id": 1,
    "nested_loop": [
      {
        "table": {
          "table_name": "t2",
          "access_type": "range",
          "possible_keys": ["a"],
          "key": "a",
          "key_length": "6",
          "used_key_parts": ["a"],
          "rows": 452,
          "filtered": 100,
          "index_condition": "t2.a >= <cache>(year_start(2018)) and t2.a <= <cache>(year_end(2018))"
        }
      }
    ]
  }
}
#
# "DATE(datetime_col) CMP date_value", basic checks
#
select count(*) from t2 where date(a) < '2017-06-01';
count(*)
190
select count(*) from t2 where a < '2017-06-01';
count(*)
190
explain format=json select * from t2 force index(a) where date(a)< '2017-06-01';
EXPLAIN
{
  "query_block": {
    "select_id": 1,
    "nested_loop": [
      {
        "table": {
          "table_name": "t2",
          "access_type": "range",
          "possible_keys": ["a"],
          "key": "a",
          "key_length": "6",
          "used_key_parts": ["a"],
          "rows": 186,
          "filtered": 100,
          "index_condition": "t2.a < <cache>(day_start('2017-06-01'))"
        }
      }
    ]
  }
}
select count(*) from t2 where date(a) <= '2017-06-01';
count(*)
190
select count(*) from t2 where a < '2017-06-02';
count(*)
190
explain format=json select * from t2 force index(a) where date(a)<='2017-06-01';
EXPLAIN
{
  "query_block": {
    "select_id": 1,
    "nested_loop": [
      {
        "table": {
          "table_name": "t2",
          "access_type": "range",
          "possible_keys": ["a"],
          "key": "a",
          "key_length": "6",
          "used_key_parts": ["a"],
          "rows": 186,
          "filtered": 100,
          "index_condition": "t2.a <= <cache>(day_end('2017-06-01'))"
        }
      }
    ]
  }
}
select count(*) from t2 where date(a) > '2018-06-01';
count(*)
350
select count(*) from t2 where a >= '2018-06-02';
count(*)
350
explain format=json select * from t2 force index(a) where date(a)> '2018-06-01';
EXPLAIN
{
  "query_block": {
    "select_id": 1,
    "nested_loop": [
      {
        "table": {
          "table_name": "t2",
          "access_type": "range",
          "possible_keys": ["a"],
          "key": "a",
          "key_length": "6",
          "used_key_parts": ["a"],
          "rows": 363,
          "filtered": 100,
          "index_condition": "t2.a > <cache>(day_end('2018-06-01'))"
        }
      }
    ]
  }
}
select count(*) from t2 where date(a) >= '2018-06-01';
count(*)
350
select count(*) from t2 where a >= '2018-06-01';
count(*)
350
explain format=json select * from t2 force index(a) where date(a)>='2018-06-01';
EXPLAIN
{
  "query_block": {
    "select_id": 1,
    "nested_loop": [
      {
        "table": {
          "table_name": "t2",
          "access_type": "range",
          "possible_keys": ["a"],
          "key": "a",
          "key_length": "6",
          "used_key_parts": ["a"],
          "rows": 363,
          "filtered": 100,
          "index_condition": "t2.a >= <cache>(day_start('2018-06-01'))"
        }
      }
    ]
  }
}
select count(*) from t2 where date(a) = '2017-06-02';
count(*)
10
select count(*) from t2 where a >= '2017-06-02' and a < '2017-06-03';
count(*)
10
explain format=json select * from t2 force index(a) where date(a)= '2017-06-02';
EXPLAIN
{
  "query_block": {
    "select_id": 1,
    "nested_loop": [
      {
        "table": {
          "table_name": "t2",
          "access_type": "range",
          "possible_keys": ["a"],
          "key": "a",
          "key_length": "6",
          "used_key_parts": ["a"],
          "rows": 10,
          "filtered": 100,
          "index_condition": "t2.a >= <cache>(day_start('2017-06-02')) and t2.a <= <cache>(day_end('2017-06-02'))"
        }
      }
    ]
  }
}
#
# Check if "YEAR(date_col) CMP year_value" works
#
select count(*) from t2 where year(b)< 2018;
count(*)
530
select count(*) from t2 where b < '2018-01-01';
count(*)
530
explain format=json select * from t2 force index(b) where year(b)<  2018;
EXPLAIN
{
  "query_block": {
    "select_id": 1,
    "nested_loop": [
      {
        "table": {
          "table_name": "t2",
          "access_type": "range",
          "possible_keys": ["b"],
          "key": "b",
          "key_length": "4",
          "used_key_parts": ["b"],
          "rows": 520,
          "filtered": 100,
          "index_condition": "t2.b < <cache>(year_start(2018))"
        }
      }
    ]
  }
}
#
# Try DATE function and DATE (not DATETIME) column:
#
select count(*) from t2 where date(b)< '2017-06-03';
count(*)
220
select count(*) from t2 where b < '2017-06-03';
count(*)
220
explain format=json select * from t2 force index(b) where date(b)< '2017-06-03';
EXPLAIN
{
  "query_block": {
    "select_id": 1,
    "nested_loop": [
      {
        "table": {
          "table_name": "t2",
          "access_type": "range",
          "possible_keys": ["b"],
          "key": "b",
          "key_length": "4",
          "used_key_parts": ["b"],
          "rows": 216,
          "filtered": 100,
          "index_condition": "t2.b < '2017-06-03'"
        }
      }
    ]
  }
}
select count(*) from t2 force index(b) where date(b)= '2017-06-04';
count(*)
10
select count(*) from t2 where b >= '2017-06-04' and b < '2017-06-05';
count(*)
10
explain format=json select * from t2 force index(b) where date(b)='2017-06-04';
EXPLAIN
{
  "query_block": {
    "select_id": 1,
    "nested_loop": [
      {
        "table": {
          "table_name": "t2",
          "access_type": "range",
          "possible_keys": ["b"],
          "key": "b",
          "key_length": "4",
          "used_key_parts": ["b"],
          "rows": 10,
          "filtered": 100,
          "index_condition": "t2.b >= '2017-06-04' and t2.b <= '2017-06-04'"
        }
      }
    ]
  }
}
#
# Check actual query results
#
insert into t2 values (10001,'2006-12-31 23:59:59','2006-12-31');
insert into t2 values (10002,'2007-01-01 00:00:00','2007-01-01');
insert into t2 values (10003,'2007-12-31 23:59:59','2007-12-31');
insert into t2 values (10004,'2008-01-01 00:00:00','2008-01-01');
explain format=json 
select * from t2 force index(b) where year(b)=2007;
EXPLAIN
{
  "query_block": {
    "select_id": 1,
    "nested_loop": [
      {
        "table": {
          "table_name": "t2",
          "access_type": "range",
          "possible_keys": ["b"],
          "key": "b",
          "key_length": "4",
          "used_key_parts": ["b"],
          "rows": 3,
          "filtered": 100,
          "index_condition": "t2.b >= <cache>(year_start(2007)) and t2.b <= <cache>(year_end(2007))"
        }
      }
    ]
  }
}
select * from t2 force index(b) where year(b)=2007;
pk	a	b
10002	2007-01-01 00:00:00	2007-01-01
10003	2007-12-31 23:59:59	2007-12-31
insert into t2 values (10010,'2006-12-31 00:00:00','2006-12-31');
insert into t2 values (10011,'2006-12-30 23:59:59','2006-12-30');
explain format=json 
select * from t2 force index(a) where date(a)='2006-12-31';
EXPLAIN
{
  "query_block": {
    "select_id": 1,
    "nested_loop": [
      {
        "table": {
          "table_name": "t2",
          "access_type": "range",
          "possible_keys": ["a"],
          "key": "a",
          "key_length": "6",
          "used_key_parts": ["a"],
          "rows": 3,
          "filtered": 100,
          "index_condition": "t2.a >= <cache>(day_start('2006-12-31')) and t2.a <= <cache>(day_end('2006-12-31'))"
        }
      }
    ]
  }
}
select * from t2 force index(a) where date(a)='2006-12-31';
pk	a	b
10010	2006-12-31 00:00:00	2006-12-31
10001	2006-12-31 23:59:59	2006-12-31
#
# Check that conditions on TIMESTAMP columns are not rewritten
#
create table t3 (a timestamp, b date, key(a));
insert into t3 select a,b from t2;
explain format=json 
select * from t3 force index(a) where year(a)>= 2007;
EXPLAIN
{
  "query_block": {
    "select_id": 1,
    "nested_loop": [
      {
        "table": {
          "table_name": "t3",
          "access_type": "ALL",
          "rows": 1006,
          "filtered": 100,
          "attached_condition": "year(t3.a) >= 2007"
        }
      }
    ]
  }
}
explain format=json 
select * from t3 force index(a) where a >= '2007-01-01 00:00:00';
EXPLAIN
{
  "query_block": {
    "select_id": 1,
    "nested_loop": [
      {
        "table": {
          "table_name": "t3",
          "access_type": "range",
          "possible_keys": ["a"],
          "key": "a",
          "key_length": "5",
          "used_key_parts": ["a"],
          "rows": 1003,
          "filtered": 100,
          "index_condition": "t3.a >= '2007-01-01 00:00:00'"
        }
      }
    ]
  }
}
drop table t3;
drop table t0,t1,t2;
